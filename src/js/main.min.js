"use strict";

window.onload = ()=>{
    AttachEvents();
    AttachGallery();
};

function AttachEvents() {
    document.querySelectorAll("div.vplayable").forEach(element => {
        if (!element.classList.contains("lex-elistener-attached"))
        {
            const video = element.children[0];
            const audio = element.children[1];
            const ctrls = element.children[2];

            const button = ctrls.children[0];
            const slider = ctrls.children[1];
            const volume = ctrls.children[2];

            video.addEventListener("click", ()=>{
                video.paused ? (video.play(), audio.play()) : (video.pause(), audio.pause());
                slider.max = video.duration;
                audio.volume = volume.value;
            });

            video.addEventListener("timeupdate", ()=>{
                slider.value = video.currentTime;
            });

            button.addEventListener("click", ()=>{
                video.paused ? (video.play(), audio.play()) : (video.pause(), audio.pause());
                slider.max = video.duration;
                audio.volume = volume.value;
            });

            slider.addEventListener("input", ()=>{
                video.paused ? void(null) : (video.pause(), audio.pause());

                video.currentTime = slider.value;
                audio.currentTime = slider.value;
            });

            volume.addEventListener("input", ()=>{
                audio.volume = volume.value;
            });

            element.classList.add("lex-elistener-attached");
        }
    });
}

function AttachGallery() {
    document.querySelectorAll(".vgallery").forEach(element => {
        if (!element.classList.contains("lex-gallerynav-attached"))
        {
            let indx = 0;
            const controls = element.querySelectorAll("svg");
            const span = element.querySelectorAll("span");
            const image = element.querySelectorAll("img");

            for (let index = 1; index < image.length; index++) {
                image[index].style.display = "none";
            }

            const back = controls[0];
            const forward = controls[1];
            const count = span[0];

            count.innerText = `1 / ${image.length}`;

            back.addEventListener("click", ()=>{
                if (indx-1<0){return;}
                indx--;
                image[indx].style.display = "block";
                image[indx+1].style.display = "none";
                count.innerText = `${indx+1} / ${image.length}`;
            });

            forward.addEventListener("click", ()=>{
                if (indx+1>image.length-1){return;}
                indx++;
                image[indx].style.display = "block";
                image[indx-1].style.display = "none";
                count.innerText = `${indx+1} / ${image.length}`;
            });
            
            element.classList.add("lex-gallerynav-attached");
        }
    });
}

function loadPosts(e) {
    document.getElementById("LoadMorePosts").remove();
    fetch(`${window.location.href.split("?")[0]}/loadPosts?after=${e}`)
    .then(e=>e.text())
    .then(e=>{document.getElementById("posts").insertAdjacentHTML("beforeend", e);})
    .then(()=>(AttachEvents(), AttachGallery()));
}
